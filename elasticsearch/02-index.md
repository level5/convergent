# 索引

索引对应数据库中的表， 文档对应成数据库表中的一条记录。  

* index是一个逻辑的namespace，他指向一个或者多个物理的shard
* shard是一个Lucene的instance，他有完整的search engine。

  a shard is a single instance of Lucene, and is a complete search engine in its own right
* shard是数据存放的地方。
* primary shard和replica shard.
  - 每一个document都属于一个primary shard
  - replica shard就是primary shard的一份拷贝
  - replica shard的作用就是数据备份和提供给查询使用
  - primary shard和replica shard不会保存在同一个node中。

    It doesn’t make sense to store copies of the same data on the same node.If we were to lose that node, we would lose all copies of our data.
* 新index进来的document，会先保存在primary shard上，然后再被复制到replica shard上。
## Document

document refers to the top-level, or root object that is serialized into JSON and stored in Elasticsearch under a unique ID.

### Document metadata

* `_index`

  This name must be lowercase, cannot begin with an underscore, and cannot contain commas
* `_type`

  A `_type` name can be lowercase or uppercase, but shouldn’t begin with an underscore or contain commas
* `_id`

  一个string。在elasticsearch中，`_id`, `_index`和`_type`一起能唯一确定一个document。
  在保存document的时候，可以自己提供，也可以由elasticsearch来创建。
  > Autogenerated IDs are 20 character long, URL-safe, Base64-encoded GUID strings

### Document

* Documents in Elasticsearch are immutable

* 当修改或者覆盖存在的document的时候，在内部，elasticsearch将老的document标记未deleted并且添加新的document。老的document不会立即消失。elasticsearch会在添加更多的document的时候删除他们

* 部分修改时
  1. Retrieve the JSON from the old document
  2. Change it
  3. Delete the old document
  4. Index a new document

#### 确保新创建一个document

* 通过POST请求,由elasticsearch来自动生成`_id`
* PUT　带上查询参数`op_type=create`
* PUT URL最后戴上`/_create`


### 乐观锁

#### 使用自带version

所有修改和删除的API都接受`version`这个参数来使用乐观锁控制这次修改。

```bash
PUT /website/blog/1?version=1
{
  "title": "My first blog entry",
  "text":  "Starting to get the hang of this..."
}
```


```bash
# 使用外部的version。
PUT /website/blog/2?version=5&version_type=external
{
  "title": "My first external blog entry",
  "text":  "Starting to get the hang of this..."
}
```

#### 使用external的version

不单只修改删除，创建时也可以使用
```
PUT /website/blog/2?version=5&version_type=external
{
  "title": "My first external blog entry",
  "text":  "Starting to get the hang of this..."
}
```

```
{
  "_index":   "website",
  "_type":    "blog",
  "_id":      "2",
  "_version": 5,
  "created":  true
}
```


### 部分修改

It is still possible that a request from another process could change the document before update has managed to reindex it.

* 如果无所谓，只需要重试的话带上参数`retry_on_conflict=5`,表示重试５次才失败。

###　取得多个结果
```
GET /_mget
{
   "docs" : [
      {
         "_index" : "website",
         "_type" :  "blog",
         "_id" :    2
      },
      {
         "_index" : "website",
         "_type" :  "pageviews",
         "_id" :    1,
         "_source": "views"
      }
   ]
}
```

```
GET /website/blog/_mget
{
   "docs" : [
      { "_id" : 2 },
      { "_type" : "pageviews", "_id" :   1 }
   ]
}
```

```
GET /website/blog/_mget
{
   "ids" : [ "2", "1" ]
}
```
这个查询即使有一个没有查到也是返回２００，需要判断结果中对应位置的对象的`found`字段


### 修改多个结果

bulk

* bulk requests are not atomic: they cannot be used to implement transactions.
* 通过测试找到合适的bulk大小。A good place to start is with batches of 1,000 to 5,000 documents or, if your documents are very large, with even smaller batches.　A good bulk size to start playing with is around 5-15MB in size
* 格式：
  ```
  { action: { metadata }}\n
  { request body        }\n
  { action: { metadata }}\n
  { request body        }\n
  ...
  ```
* Every line must end with a newline character (\n), including the last line. These are used as markers to allow for efficient line separation
* The lines cannot contain unescaped newline characters, as they would interfere with parsing. This means that the JSON must not be pretty-printed.
* The action/metadata line specifies what action to do to which document.
  - `create`
  - `index` 新增或者替换
  - `update`
  - `delete`
* The metadata should specify the `_index`, `_type`, and `_id` of the document to be indexed, created, updated, or deleted
* 对于create和update, The request body line consists of the document `_source` itself
* 对于update, ...
* 对于delete,不需要body
